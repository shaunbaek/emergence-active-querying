# Emergence Spatial

Multi-agent navigation experiments in AI2-THOR environments using LLM-based policies.

## Setup Instructions

### 1. Create a Virtual Environment

First, create a Python virtual environment to isolate project dependencies:

```bash
python3 -m venv .venv
```

> **Note:** You can rename `.venv` to any name you prefer (e.g., `venv`, `env`, etc.)

### 2. Activate the Virtual Environment

Activate the virtual environment using:

```bash
source .venv/bin/activate
```

> **Note:** On Windows, use `.venv\Scripts\activate` instead

### 3. Install Dependencies

Once the virtual environment is activated, upgrade pip and install the required packages:

```bash
# Upgrade pip to the latest version
pip install --upgrade pip

# Install all project dependencies from requirements.txt
pip install -r requirements.txt
```

**Required packages:**
- `ai2thor` - AI2-THOR 3D simulator
- `matplotlib` - Plotting and visualization
- `google-generativeai` - Google Gemini API
- `python-dotenv` - Environment variable management

### 4. Configure Environment Variables

Create a `.env` file in the project root directory by copying the example file:

```bash
cp .env.example .env
```

Then edit the `.env` file and add your Gemini API key:

```
GEMINI_API_KEY=your_actual_api_key_here
```

> **Note:** You can get your Gemini API key from [Google AI Studio](https://makersuite.google.com/app/apikey)

### 5. Running the Project

After completing the setup, you can run navigation experiments with different policies and task sets.

## Running Navigation Experiments

### Task Sets

The project includes several pre-configured task sets (generated in `tasks_utils.py`):

- **`full100`** - âœ… **RECOMMENDED**: 100 tasks randomly sampled from all room types (with fixed seed for reproducibility)
  - Consistent task set across runs
  - Balanced distribution across all room types
  - Generated by `generate_task_list_100()` in `tasks_utils.py`
- **`dev20`** - 20 development tasks for quick testing
  - Generated by `generate_dev_task_list_20()` in `tasks_utils.py`
- **`custom100`** - 100 specific test cases (25 per room type):
  - Kitchen (FloorPlan 1-30): 25 tasks
  - Living Room (FloorPlan 201-230): 25 tasks
  - Bedroom (FloorPlan 301-330): 25 tasks
  - Bathroom (FloorPlan 401-430): 25 tasks
  - Loaded from `tasks_custom_100.json`

### Agent Policies

Three different policies are available:

- **`baseline`** - Single agent with full visibility and rich perception
- **`handicapped`** - Single agent with limited perception (only sees nearby objects)
- **`two_agent`** - Leader (full visibility) + Handicapped agent with communication

### Running Experiments

**Basic usage** - Use `full100` from `tasks_utils.py` for reproducible 100-task experiments:

```bash
# Run baseline policy on 100 tasks (RECOMMENDED)
python3 loop.py --policy baseline --taskset full100 --max_steps 30

# Run handicapped policy on 100 tasks
python3 loop.py --policy handicapped --taskset full100 --max_steps 30

# Run two-agent policy on 100 tasks
python3 loop.py --policy two_agent --taskset full100 --max_steps 30

# Resume interrupted run (skip already completed tasks)
# NOTE: You must specify --max_steps when using --resume to maintain consistency
python3 loop.py --policy baseline --taskset full100 --max_steps 30 --resume
python3 loop.py --policy handicapped --taskset full100 --max_steps 30 --resume
python3 loop.py --policy two_agent --taskset full100 --max_steps 30 --resume
```

Alternative task sets:

```bash
# Run on custom 100 tasks (evenly distributed: 25 per room type)
python3 loop.py --policy baseline --taskset custom100 --max_steps 30

# Run on dev tasks (20 tasks for quick testing)
python3 loop.py --policy baseline --taskset dev20 --max_steps 30
```

### Command-line Arguments

- `--policy` - Choose agent policy: `baseline`, `handicapped`, or `two_agent` (default: `baseline`)
- `--taskset` - Choose task set: `dev20`, `full100`, or `custom100` (default: `full100`)
  - **`full100` is RECOMMENDED** - 100 reproducible tasks from `tasks_utils.py`
- `--max_steps` - Maximum steps per episode (default: `50`)
- `--resume` - Skip tasks that already have log files (useful for resuming interrupted runs)

> **Important**: When using `--resume`, always specify `--max_steps` to ensure consistency with your previous run. The default is 50 steps if not specified.

### Results

Episode logs are saved to:
- `logs/baseline/` - Baseline policy results
- `logs/handicapped/` - Handicapped policy results
- `logs/two_agent/` - Two-agent policy results

Each task produces a JSON file named `task_<id>.json` containing:
- Task metadata (scene, room type, target object, goal)
- Episode duration
- Step-by-step trajectory with actions, positions, and distances
- Agent memory and communication logs (for two-agent policy)

### Generating Task Files

To regenerate the task files:

```bash
# Generate all standard task sets
python tasks_utils.py

# Generate custom 100 tasks
python tasks_custom_100.py
```

### Run All Experiments at Once

For convenience, use the provided script to run all 100 tasks across all three policies sequentially:

```bash
# Run all experiments
./run_all_experiments.sh

# Run with resume support (skip completed tasks)
./run_all_experiments.sh --resume

# Customize max steps per task
./run_all_experiments.sh --max-steps 75
```

This script will:
1. Check prerequisites (virtual environment, .env file)
2. Generate task files if needed
3. Run baseline policy (100 tasks)
4. Run handicapped policy (100 tasks)
5. Run two-agent policy (100 tasks)
6. Report completion status

**Note**: Running all experiments takes approximately 3-7.5 hours total.

## Troubleshooting

### Missing Module Errors

If you encounter `ModuleNotFoundError`, ensure all dependencies are installed:

```bash
pip install -r requirements.txt
```

### Missing env.py

The project requires `env.py` which provides the `ThorEnv` wrapper for AI2-THOR. This file should be present in the project root.

### API Key Issues

Verify your Gemini API key is properly configured:

```bash
cat .env | grep GEMINI_API_KEY
```

### AI2-THOR Display Issues

If running on a headless server or encountering display issues, AI2-THOR may need additional configuration. Refer to the [AI2-THOR documentation](https://ai2thor.allenai.org/ithor/documentation/) for details.

## Deactivating the Virtual Environment

When you're done working on the project, you can deactivate the virtual environment:

```bash
deactivate
```
